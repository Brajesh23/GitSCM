--! echo completed loading into scct_db.trxn_day_site_assc_hr_pyrl ;
---jobname:scct-aces-hive-stg1-scct_work_db.dy_pyrl_pos_audited_tmp -------------------------------------------------------------------------- ---target: stage1 table: scct_work_db.dy_pyrl_pos_audited_tmp ---source: maprdb_stage0.dy_pyrl_pos_audited_maprdb, scct_work_db.aces_audited_job_control ---load type: incremental load ---back posting: yes --------------------------------------------------------------------------  -- history information -- -- revision date jira developer-id comments -- ----------- ------- ---------- ------------ ---------------------------- -- 01.00.00.01 10feb20 scctp4-3096 ryadav initial version -- 01.00.00.02 24feb20 scctp4-3138 ryadav updated delta logic -- 01.00.00.03 03mar20 scctp4-3258 ryadav update logic to take unique records from paycode  ------------------------- ---loading scct_work_db.dy_pyrl_pos_audited_tmp work table data -------------------------  --set tez.job.name=stage1_scct_db:dy_pyrl_pos_audited_tmp :load work table dy_pyrl_pos_audited_tmp ;
--! echo started loading into scct_work_db.dy_pyrl_pos_audited_tmp ;
insert overwrite into scct_work_db.dy_pyrl_pos_audited_tmp select lgcy_sto_nbr  ,brnd_cd   ,assc_ssn_nbr   ,clk_pnch_in_dttm  ,clk_pnch_out_dttm  ,round(datediff(days,cast(clk_pnch_out_dttm as timestamp) , cast(clk_pnch_in_dttm as timestamp))*24  +datediff(hours,cast(clk_pnch_out_dttm as timestamp) , cast(clk_pnch_in_dttm as timestamp))  +datediff(minutes,cast(clk_pnch_out_dttm as timestamp) , cast(clk_pnch_in_dttm as timestamp))/60  +datediff(seconds,cast(clk_pnch_out_dttm as timestamp) , cast(clk_pnch_in_dttm as timestamp))/(60*60),2) as pyrl_hr_amt  ,pos_pyrl_cd  ,' ' as hrly_ind  ,dateadd(day,-1,current_date) as trxn_post_dt  ,clk_pnch_evnt_id  ,lst_mod_dttm  ,lst_mod_pty_id_val  ,rec_ins_dttm  ,pyrl_tme_typ_nme  ,prod_pyrl_ind  ,tplh_flg_ind from  (select lgcy_sto_nbr  ,brnd_cd   ,assc_ssn_nbr   ,clk_pnch_in_dttm  ,case when datediff(days,clk_pnch_out_dttm,clk_pnch_in_dttm) >2 then concat(dateadd(day,1,clk_pnch_in_dttm) ,' ','00:00:00')   else clk_pnch_out_dttm end as clk_pnch_out_dttm  ,pos_pyrl_cd  ,clk_pnch_evnt_id  ,lst_mod_dttm  ,lst_mod_pty_id_val  ,rec_ins_dttm  ,pyrl_tme_typ_nme  ,prod_pyrl_ind  ,tplh_flg_ind from (  select pos.lgcy_sto_nbr   ,pos.brnd_cd as brnd_cd   ,pos.pty_id_val   ,pos.pty_id_val as assc_ssn_nbr   ,pos.clk_pnch_in_dttm   ,cast(pos.clk_pnch_in_dttm as date) as pnch_in_dt   ,substr(pos.clk_pnch_in_dttm,11,9) as pnch_in_tm  ,from_unixtime(unix_timestamp(coalesce(pos.clk_pnch_out_dttm,pos.clk_pnch_in_dttm))+0) as clk_pnch_out_dttm --+14400  ,cast(from_unixtime(unix_timestamp(coalesce(pos.clk_pnch_out_dttm,pos.clk_pnch_in_dttm))+0) as date) as pnch_out_dt --+ interval '04:00:00' hour to second) as date) as pnch_out_dt   ,substr(from_unixtime(unix_timestamp(coalesce(pos.clk_pnch_out_dttm,pos.clk_pnch_in_dttm))+0),11,9) as pnch_out_tm --+ interval '04:00:00' hour to second) as time(6) with time zone) as pnch_out_tm   ,coalesce(pos.pyrl_tme_typ_cd,'00103') as pos_pyrl_cd  ,pos.clk_pnch_evnt_id as clk_pnch_evnt_id  ,pos.lst_mod_dttm as lst_mod_dttm  ,pos.lst_mod_pty_id_val as lst_mod_pty_id_val1  ,pos.lst_mod_pty_id_val  ,pos.rec_ins_dttm  ,coalesce(pctt.pyrl_tme_typ_nme,'n/a') as pyrl_tme_typ_nme  ,coalesce(pctt.prod_pyrl_ind,'n/a') as prod_pyrl_ind  ,coalesce(pctt.tplh_flg_ind,'n/a') as tplh_flg_ind  from (select coalesce(case when trim(dpam.brnd_cd)='' then null else trim(dpam.brnd_cd) end, 'n/a') as brnd_cd  ,coalesce(case when dpam.lgcy_sto_nbr='' then null else dpam.lgcy_sto_nbr end, 0) as lgcy_sto_nbr  ,coalesce(case when dpam.clk_pnch_evnt_id='' then null else dpam.clk_pnch_evnt_id end, 0) as clk_pnch_evnt_id  ,coalesce(case when trim(dpam.pty_id_val)='' then null else trim(dpam.pty_id_val) end, 'n/a') as pty_id_val  ,coalesce(case when dpam.clk_pnch_in_dttm='' then null else dpam.clk_pnch_in_dttm end, '9999-12-31 00:00:00') as clk_pnch_in_dttm  ,coalesce(case when dpam.clk_pnch_out_dttm='' then null else dpam.clk_pnch_out_dttm end, '9999-12-31 00:00:00') as clk_pnch_out_dttm  ,coalesce(case when trim(dpam.pyrl_tme_typ_cd)='' then null else trim(dpam.pyrl_tme_typ_cd) end, 'n/a') as pyrl_tme_typ_cd  ,coalesce(case when trim(dpam.lst_mod_dttm)='' then null else trim(dpam.lst_mod_dttm) end, '9999-12-31 00:00:00') as lst_mod_dttm  ,coalesce(case when trim(dpam.lst_mod_pty_id_val)='' then null else trim(dpam.lst_mod_pty_id_val) end, 'n/a') as lst_mod_pty_id_val  ,coalesce(case when dpam.rec_ins_dttm='' then null else dpam.rec_ins_dttm end, '9999-12-31 00:00:00') as rec_ins_dttm from maprdb_stage0.dy_pyrl_pos_audited_maprdb as dpam inner join(select unix_timestamp(job_end_ts)-(5*60) as jet from scct_work_db.aces_audited_job_control) as auc on unix_timestamp(dpam.rec_ins_dttm)>= auc.jet where dpam.clk_pnch_in_dttm<>dpam.clk_pnch_out_dttm ) pos left outer join (select pos_pyrl_cd, brnd_cd, pyrl_tme_typ_nme, prod_pyrl_ind, tplh_flg_ind from scct_work_db.payroll_company_time_type_tmp3  group by pos_pyrl_cd, brnd_cd, pyrl_tme_typ_nme, prod_pyrl_ind, tplh_flg_ind) pctt on pos.pyrl_tme_typ_cd = pctt.pos_pyrl_cd and pos.brnd_cd = pctt.brnd_cd )t )t1
--! echo completed loading into scct_work_db.dy_pyrl_pos_audited_tmp ;
