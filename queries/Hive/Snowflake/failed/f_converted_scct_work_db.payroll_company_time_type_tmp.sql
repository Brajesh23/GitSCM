--posexplode(split(space((div(enddt,(60*60)) - div(strtdt,(60*60)))::int-1),' ')) pe;
--! echo completed loading into scct_work_db.dy_pyrl_pos_audited_unaudited_tmp2 ;
---jobname:scct-aces-hive-stg1-scct_work_db.dy_pyrl_pos_audited_unaudited_tmp2 -------------------------------------------------------------------------- ---target: stage1 table: scct_work_db.dy_pyrl_pos_audited_unaudited_tmp2 ---source: scct_work_db.dy_pyrl_pos_audited_unaudited_master ---load type: full load ---back posting: yes --------------------------------------------------------------------------  -- history information -- -- revision date jira developer-id comments -- ----------- ------- ---------- ------------ ---------------------------- -- 01.00.00.01 10feb20 scctp4-3096 ryadav initial version -- 01.00.00.02 03mar20 scctp4-3258 ryadav added aggregation while joining payroll_company_time_type_tmp2   ------------------------- ---loading scct_work_db.dy_pyrl_pos_audited_unaudited_tmp2 work table data -------------------------  --set tez.job.name=stage1_scct_db:dy_pyrl_pos_audited_unaudited_tmp2 :load work table dy_pyrl_pos_audited_unaudited_tmp2 ;
--! echo started loading into scct_work_db.dy_pyrl_pos_audited_unaudited_tmp2 ;
insert overwrite into scct_work_db.payroll_company_time_type_tmp select coalesce(case when xref.co_cd_org_pty_id=0 then null else xref.co_cd_org_pty_id end, 0) as co_cd_org_pty_id ,coalesce(case when trim(xref.bus_unt_cd)='' then null else trim(xref.bus_unt_cd) end, 'n/a') as bus_unt_cd ,coalesce(case when trim(xref.brnd_cd)='' then null else trim(xref.brnd_cd) end, 'n/a') as brnd_cd ,coalesce(case when trim(pt.payroll_time_type_cd)='' then null else trim(pt.payroll_time_type_cd) end, 'n/a') as pyrl_tme_typ_cd ,coalesce(case when trim(pt.pos_time_type_cd)='' then null else trim(pt.pos_time_type_cd) end, 'n/a') as pos_pyrl_cd ,coalesce(case when trim(pt.pos_time_type_desc)='' then null else trim(pt.pos_time_type_desc) end, 'n/a') as pyrl_tme_typ_nme ,'' as ps_pyrl_cd ,coalesce(case when trim(pt.productive_flag)='' then null else trim(pt.productive_flag) end, 'n/a') as prod_pyrl_ind ,coalesce(case when trim(pt.tplh_flag)='' then null else trim(pt.tplh_flag) end, 'n/a') as tplh_flag from aces_stage0.ps_paycode_type pt join scct_db.payroll_company_brand_xref xref where business_unit = bus_unt_cd
insert overwrite into scct_work_db.payroll_company_time_type_tmp2 select pctt.co_cd_org_pty_id  ,pctt.brnd_cd  , pctt.pyrl_tme_typ_cd  , pctt.pos_pyrl_cd  , max(pctt.pyrl_tme_typ_nme)  , pctt.ps_pyrl_cd  , pctt.prod_pyrl_ind  , pctt.tplh_flg_ind   , x.brnd_dflt_ind from scct_work_db.payroll_company_time_type_tmp pctt inner join scct_db.payroll_company_brand_xref x on pctt.co_cd_org_pty_id = x.co_cd_org_pty_id group by pctt.co_cd_org_pty_id, pctt.brnd_cd, pctt.pyrl_tme_typ_cd, pctt.pos_pyrl_cd, pctt.ps_pyrl_cd, pctt.prod_pyrl_ind, pctt.tplh_flg_ind, x.brnd_dflt_ind
insert overwrite into scct_work_db.payroll_company_time_type_tmp3  select t.brnd_cd  , t.pyrl_tme_typ_cd  , t.pos_pyrl_cd  , max(t.pyrl_tme_typ_nme) pyrl_tme_typ_nme  , t.ps_pyrl_cd  , t.prod_pyrl_ind  , t.tplh_flg_ind  from (select pctt1.brnd_cd  , pctt1.pyrl_tme_typ_cd  , pctt1.pos_pyrl_cd  , pctt1.pyrl_tme_typ_nme  , pctt1.ps_pyrl_cd  , pctt1.prod_pyrl_ind  , pctt1.tplh_flg_ind  from scct_work_db.payroll_company_time_type_tmp2 pctt1 left outer join (select brnd_cd,pyrl_tme_typ_cd,min(pos_pyrl_cd) as pos_pyrl_cd  from scct_work_db.payroll_company_time_type_tmp2  where brnd_dflt_ind = 'y'  group by brnd_cd,pyrl_tme_typ_cd) pctt2 on pctt1.brnd_cd=pctt2.brnd_cd and pctt1.pyrl_tme_typ_cd=pctt2.pyrl_tme_typ_cd and pctt1.pos_pyrl_cd=pctt2.pos_pyrl_cd where pctt1.brnd_dflt_ind = 'y' and pctt1.pyrl_tme_typ_cd <> '-' and pctt2.brnd_cd is not null and pctt2.pyrl_tme_typ_cd is not null and pctt2.pos_pyrl_cd is not null union all select pctt1.brnd_cd  , pctt1.pyrl_tme_typ_cd  , pctt1.pos_pyrl_cd  , pctt1.pyrl_tme_typ_nme  , pctt1.ps_pyrl_cd  , pctt1.prod_pyrl_ind  , pctt1.tplh_flg_ind from scct_work_db.payroll_company_time_type_tmp2 pctt1 left outer join (select brnd_cd, pyrl_tme_typ_cd from scct_work_db.payroll_company_time_type_tmp2   where brnd_dflt_ind = 'y' group by brnd_cd, pyrl_tme_typ_cd) pctt2 on pctt1.brnd_cd=pctt2.brnd_cd and pctt1.pyrl_tme_typ_cd=pctt2.pyrl_tme_typ_cd left outer join (select brnd_cd, pyrl_tme_typ_cd, min(pos_pyrl_cd) pos_pyrl_cd from scct_work_db.payroll_company_time_type_tmp2   where brnd_dflt_ind = 'n'  group by brnd_cd, pyrl_tme_typ_cd) pctt3 on pctt1.brnd_cd=pctt3.brnd_cd and pctt1.pyrl_tme_typ_cd=pctt3.pyrl_tme_typ_cd and pctt1.pos_pyrl_cd=pctt3.pos_pyrl_cd where pctt1.brnd_dflt_ind <> 'y' and pctt1.pyrl_tme_typ_cd <> '-' and pctt2.brnd_cd is null and pctt2.pyrl_tme_typ_cd is null and pctt3.brnd_cd is not null and pctt3.pyrl_tme_typ_cd is not null and pctt3.pos_pyrl_cd is not null union all select pctt1.brnd_cd  , pctt1.pyrl_tme_typ_cd  , pctt1.pos_pyrl_cd  , pctt1.pyrl_tme_typ_nme  , pctt1.ps_pyrl_cd  , pctt1.prod_pyrl_ind  , pctt1.tplh_flg_ind from scct_work_db.payroll_company_time_type_tmp2 pctt1 where pyrl_tme_typ_cd = '-')t group by brnd_cd  , pyrl_tme_typ_cd  , pos_pyrl_cd  , ps_pyrl_cd  , prod_pyrl_ind  , tplh_flg_ind
--! echo completed loading into scct_work_db.payroll_company_time_type_tmp3 ;
